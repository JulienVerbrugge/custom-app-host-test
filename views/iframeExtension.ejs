<h1>Akeneo Iframe Extension</h1>

<!-- get token -->
<button id="requestJwtButton">Request JWT</button>
<pre id="tokenDisplay" style="display:none;"></pre>
<pre id="decodedToken" style="display:none;"></pre>
<!-- verify signature -->
<div id="secretInputContainer" style="display:none;">
    <label for="secretInput">Enter Secret:</label>
    <input type="text" id="secretInput" placeholder="Enter your secret here" />
    <button id="submitSecretButton">Submit Secret</button>
</div>
<pre id="verificationResult" style="display:none;"></pre>

<script>
    let jwt = '';
    let secret = '';

    document.getElementById('requestJwtButton').addEventListener('click', function() {
        // Request the JWT from the parent window
        window.parent.postMessage({ type: 'request_jwt' }, "*");
    });

    // Listen for messages from the parent window
    window.addEventListener('message', function(event) {
        if (event.data.type === 'JWT_TOKEN') {
            jwt = event.data.token;
            document.getElementById('tokenDisplay').textContent = jwt;
            document.getElementById('tokenDisplay').style.display = 'block';

            // Decode the JWT
            const payload = jwt.split('.')[1]; // Get the payload part
            const decodedPayload = JSON.parse(atob(payload)); // Decode base64
            document.getElementById('decodedToken').textContent = JSON.stringify(decodedPayload, null, 2);
            document.getElementById('decodedToken').style.display = 'block';

            // Show the verify button and secret input
            // document.getElementById('verifyJwtButton').style.display = 'block';
            document.getElementById('secretInputContainer').style.display = 'block';
        }
    });

    document.getElementById('submitSecretButton').addEventListener('click', function() {
        secret = document.getElementById('secretInput').value;
        fetch('/verify-token', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ token: jwt, secret: secret }) // Send the secret along with the token
        })
        .then(response => response.json())
        .then(data => {
            document.getElementById('verificationResult').textContent = JSON.stringify(data, null, 2);
            document.getElementById('verificationResult').style.display = 'block';
        })
        .catch(error => {
            console.error('Error verifying token:', error);
        });
    });
</script>